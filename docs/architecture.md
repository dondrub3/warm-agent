# 系统架构 System Architecture 🏗️

## 整体架构

Warm Agent 采用微服务架构，分为四层：

### 1. 用户层 (User Layer)
- **QQ Bot**: 通过QQ Bot提供情感陪伴服务
- **微信 Bot**: 通过微信公众号提供情感支持
- **Web App**: 提供Web界面进行情感记录和分析
- **API 客户端**: 第三方应用通过API集成

### 2. 接入层 (Gateway Layer)
- **API Gateway**: 基于OpenClaw的统一接入管理
- **功能**:
  - 统一身份认证和授权
  - 请求限流和负载均衡
  - API版本管理
  - 监控和日志收集

### 3. 服务层 (Service Layer)
- **情感分析服务**: 多模态情感状态识别
- **情感记忆引擎**: 长期情感模式学习和检索
- **共情生成服务**: 温暖回应生成和情感合成
- **用户管理服务**: 用户配置和个性化设置

### 4. 数据层 (Data Layer)
- **PostgreSQL**: 存储结构化数据（用户信息、配置、日志）
- **Milvus**: 向量数据库，用于情感记忆的相似性检索
- **Redis**: 缓存层，提高响应速度
- **对象存储**: 存储音频、图片等多媒体文件

## 技术栈

### 后端技术
- **语言**: Python 3.8+
- **Web框架**: FastAPI (高性能异步框架)
- **数据库**: PostgreSQL 14+ (关系型数据)
- **向量数据库**: Milvus 2.3+ (向量检索)
- **缓存**: Redis 7+ (内存缓存)
- **消息队列**: RabbitMQ (异步任务处理)
- **容器化**: Docker + Docker Compose

### 前端技术
- **Web框架**: React 18+ (用户界面)
- **状态管理**: Redux Toolkit
- **UI组件**: Ant Design
- **构建工具**: Vite

### 部署和运维
- **容器编排**: Kubernetes (生产环境)
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack (Elasticsearch, Logstash, Kibana)
- **CI/CD**: GitHub Actions

## 数据流

### 情感分析流程
```
用户输入 → 多模态预处理 → 特征提取 → 情感分类 → 情感状态输出
```

### 记忆存储流程
```
情感状态 → 向量化 → 结构化存储 → 向量存储 → 模式学习
```

### 共情生成流程
```
当前情感 + 历史记忆 → 策略选择 → 模板填充 → 情感合成 → 温暖回应
```

## 扩展性设计

### 水平扩展
- **无状态服务**: 所有服务都是无状态的，支持水平扩展
- **数据库分片**: 支持用户数据的分片存储
- **缓存集群**: Redis集群支持高并发访问

### 插件化架构
- **情感分析插件**: 支持不同的情感分析算法
- **存储插件**: 支持不同的数据库后端
- **输出插件**: 支持不同的输出格式和渠道

### API设计原则
- **RESTful设计**: 遵循RESTful API设计规范
- **版本管理**: 清晰的API版本管理策略
- **文档自动生成**: 使用OpenAPI自动生成API文档

## 安全性设计

### 数据安全
- **端到端加密**: 敏感数据传输使用TLS加密
- **数据脱敏**: 用户隐私数据脱敏处理
- **访问控制**: 基于角色的访问控制(RBAC)

### 隐私保护
- **数据最小化**: 只收集必要的情感数据
- **用户控制**: 用户可随时删除自己的数据
- **合规性**: 符合GDPR等隐私保护法规

## 性能指标

### 响应时间
- **情感分析**: < 100ms (文本), < 500ms (语音/图像)
- **记忆检索**: < 50ms
- **共情生成**: < 200ms

### 吞吐量
- **单节点**: 支持1000+ QPS
- **集群**: 支持10000+ QPS

### 可用性
- **目标**: 99.9% 可用性
- **监控**: 实时监控和告警
- **备份**: 定期数据备份和恢复测试

## 部署架构

### 开发环境
- **本地开发**: Docker Compose
- **测试环境**: 独立的测试集群

### 生产环境
- **高可用集群**: 多可用区部署
- **负载均衡**: 使用云负载均衡器
- **CDN**: 静态资源通过CDN加速

---

*此文档描述了Warm Agent的系统架构和技术栈，为开发者提供技术参考。*